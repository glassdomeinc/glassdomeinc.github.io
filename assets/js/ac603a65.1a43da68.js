"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[9037],{4137:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var i=n.createContext({}),p=function(e){var t=n.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(i.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(a),m=r,h=d["".concat(i,".").concat(m)]||d[m]||u[m]||o;return a?n.createElement(h,s(s({ref:t},c),{},{components:a})):n.createElement(h,s({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,s=new Array(o);s[0]=d;var l={};for(var i in t)hasOwnProperty.call(t,i)&&(l[i]=t[i]);l.originalType=e,l.mdxType="string"==typeof e?e:r,s[1]=l;for(var p=2;p<o;p++)s[p]=a[p];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},6389:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>i,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var n=a(7462),r=(a(7294),a(4137));const o={slug:"persistent-storage-increase",title:"How to increase persistent storage capacity for a stateful set on K8s with no downtime",authors:"adil",tags:["kubernetes","statefulset","storage","persistent","volume","capacity","increase","downtime"]},s=void 0,l={permalink:"/blog/persistent-storage-increase",source:"@site/blog/2022-12-1-persistent-volume-increase.md",title:"How to increase persistent storage capacity for a stateful set on K8s with no downtime",description:"Why do we need this?",date:"2022-12-01T00:00:00.000Z",formattedDate:"2022\ub144 12\uc6d4 1\uc77c",tags:[{label:"kubernetes",permalink:"/blog/tags/kubernetes"},{label:"statefulset",permalink:"/blog/tags/statefulset"},{label:"storage",permalink:"/blog/tags/storage"},{label:"persistent",permalink:"/blog/tags/persistent"},{label:"volume",permalink:"/blog/tags/volume"},{label:"capacity",permalink:"/blog/tags/capacity"},{label:"increase",permalink:"/blog/tags/increase"},{label:"downtime",permalink:"/blog/tags/downtime"}],readingTime:1.795,hasTruncateMarker:!0,authors:[{name:"Adil",title:"Software Engineer",url:"https://github.com/adilb99",imageURL:"https://avatars.githubusercontent.com/u/47117931?v=4",key:"adil"}],frontMatter:{slug:"persistent-storage-increase",title:"How to increase persistent storage capacity for a stateful set on K8s with no downtime",authors:"adil",tags:["kubernetes","statefulset","storage","persistent","volume","capacity","increase","downtime"]},nextItem:{title:"Creating an API Gateway for your backend with KrakenD",permalink:"/blog/krakend"}},i={authorsImageUrls:[void 0]},p=[{value:"Why do we need this?",id:"why-do-we-need-this",level:2},{value:"How to do it",id:"how-to-do-it",level:2},{value:"References",id:"references",level:2}],c={toc:p};function u(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"why-do-we-need-this"},"Why do we need this?"),(0,r.kt)("p",null,"Certain applications that run on Kubernetes are deployed via deployments and some via stateful sets. Database systems like Clickhouse are usually deployed via stateful sets. "),(0,r.kt)("p",null,"However, storage disks for such databases can easily run out of space and become full and if we try to increase the capacity in-place for the running stateful set, we can run into an error:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"StatefulSet.apps <appName> is invalid: spec: Forbidden: updates to statefulset > spec for fields other than 'replicas', 'template', and 'updateStrategy' are forbidden.\n")),(0,r.kt)("p",null,"The first solution to this that comes to mind is to simply re-create the stateful set. For that, however, we need to stop and remove the stateful set and all its pods, transfer the data from the volume to a backup storage, re-create everything and move the data. This can create a good amount of downtime many applications cannot afford."),(0,r.kt)("p",null,"Fortunately, there is an easy workaround that allows no downtime."),(0,r.kt)("br",null),(0,r.kt)("h2",{id:"how-to-do-it"},"How to do it"),(0,r.kt)("p",null,"For each persistent volume claim (PVC) in the stateful set, edit both the current capacity and the requested capacity either via:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ kubectl edit pvc <name> --namespace <namespace>\n")),(0,r.kt)("p",null,"or by using k9s and pressing E on the PVC entity."),(0,r.kt)("br",null),(0,r.kt)("p",null,"Then, delete the stateful set like such:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ kubectl delete sts --cascade=orphan <name> --namespace <namespace>\n")),(0,r.kt)("p",null,"In this case, by specifying the flag 'orphan', we will leave all pods and services running as orphans without the stateful set, thus no downtime."),(0,r.kt)("br",null),(0,r.kt)("p",null,"Then, don't forget to change the configuration for the stateful set, either in your helm chart value file, or in your yaml config. "),(0,r.kt)("p",null,"Re-create the stateful set either as such:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ kubectl apply -f <name>\n")),(0,r.kt)("p",null,"Or if you use helm, by re-installing the helm chart via:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ helm upgrade --install\n")),(0,r.kt)("br",null),(0,r.kt)("p",null,"After that, the stateful set should be back and you need to update the pods by restarting them with:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ kubectl rollout restart sts <name> --namespace <namespace>\n")),(0,r.kt)("p",null,"During restart, the pod's PVC will be resized. Problem solved!"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Happy coding!~")),(0,r.kt)("h2",{id:"references"},"References"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://itecnotes.com/server/how-to-increase-disk-size-in-a-stateful-set/"},"How to increase disk size in a stateful set"))))}u.isMDXComponent=!0}}]);